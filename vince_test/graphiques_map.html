<!DOCTYPE html>
<meta charset="utf-8">
<style>

body {
  margin: 0;
}

#mapCanvas, #chartCanvas {
  position: absolute;
  top: 0;
  bottom: 0;
  right: 0;
  left: 0;
  overflow: hidden;
}

#chartCanvas {
  pointer-events: none;
}
#chartCanvas circle {
  pointer-events: auto;
}

.layer {
  position: absolute;
}

.tile {
  pointer-events: none;
  position: absolute;
  width: 256px;
  height: 256px;
}

.info {
  position: absolute;
  bottom: 10px;
  left: 10px;
}

</style>
<body>
<script src="libs/jquery-2.1.1.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.geo.tile.v0.min.js"></script>

<div>
  <div id="mapCanvas"></div>
  <div id="chartCanvas"></div>
</div>

<script>


/********************************
 **     MAP
 ********************************/

var width = Math.max(960, window.innerWidth),
    height = Math.max(500, window.innerHeight),
    prefix = prefixMatch(["webkit", "ms", "Moz", "O"]);

var tile = d3.geo.tile()
    .size([width, height]);

var projection = d3.geo.mercator();

var zoom = d3.behavior.zoom()
    .scale(1 << 12)
    .scaleExtent([1 << 9, 1 << 23])
    .translate([width / 2, height / 2])
    .on("zoom", zoomed);

var map = d3.select("#mapCanvas").append("div")
    .style("width", width + "px")
    .style("height", height + "px")
    .call(zoom)
    .on("mousemove", mousemoved);

var layer = map.append("div")
    .attr("class", "layer");

var info = map.append("div")
    .attr("class", "info");

zoomed();


/********************************
 **     CIRCLES
 ********************************/

var data = [];

var svg = d3.select("#chartCanvas").append("svg:svg")
        .attr("width", width)
        .attr("height", height);

var circle;



function zoomed() {
  var tiles = tile
      .scale(zoom.scale())
      .translate(zoom.translate())
      ();

  projection
      .scale(zoom.scale() / 2 / Math.PI)
      .translate(zoom.translate());

  var image = layer
      .style(prefix + "transform", matrix3d(tiles.scale, tiles.translate))
    .selectAll(".tile")
      .data(tiles, function(d) { return d; });

  image.exit()
      .remove();

  image.enter().append("img")
      .attr("class", "tile")
      .attr("src", function(d) { return "http://" + ["a", "b", "c", "d"][Math.random() * 4 | 0] + ".tiles.mapbox.com/v3/examples.map-i86nkdio/" + d[2] + "/" + d[0] + "/" + d[1] + ".png"; })
      .style("left", function(d) { return (d[0] << 8) + "px"; })
      .style("top", function(d) { return (d[1] << 8) + "px"; });


  if (data) {

    circle.attr("cx", function(d) { return projection([d.longitude, d.latitude])[0]; })
          .attr("cy", function(d) { return projection([d.longitude, d.latitude])[1]; })

  };
      
}

function mousemoved() {
  info.text(formatLocation(projection.invert(d3.mouse(this)), zoom.scale()));
}

function matrix3d(scale, translate) {
  var k = scale / 256, r = scale % 1 ? Number : Math.round;
  return "matrix3d(" + [k, 0, 0, 0, 0, k, 0, 0, 0, 0, k, 0, r(translate[0] * scale), r(translate[1] * scale), 0, 1 ] + ")";
}

function prefixMatch(p) {
  var i = -1, n = p.length, s = document.body.style;
  while (++i < n) if (p[i] + "Transform" in s) return "-" + p[i].toLowerCase() + "-";
  return "";
}

function formatLocation(p, k) {
  var format = d3.format("." + Math.floor(Math.log(k) / 2 - 2) + "f");
  return (p[1] < 0 ? format(-p[1]) + "째S" : format(p[1]) + "째N") + " "
       + (p[0] < 0 ? format(-p[0]) + "째W" : format(p[0]) + "째E");
}




/********************************
 ** FILE: BaseManager.js
 ********************************/

function loadListeEts(){

  var ipVince = '192.168.75.133';
  var dbname='postgres';
  var table='epmsi_dgf_11_13_84';


  var urlGet = 'http://' + ipVince + ':4000/database/' + dbname + '/listeEts';

  $.ajax({
    type: "GET",
    url: urlGet,
    cache:false,
    data: {tableName : table},
      jsonpCallback : 'listeEtsJsonpCallback',
    dataType: "jsonp"
  });

}


function listeEtsJsonpCallback(json) {
    if (!json.Error) {

    var result = '';
    var geojsonFeature;




    //filtre json pour ne garde que les valeurs non nulles
    var i =0;
    for (var j = 0; j < json.length; j++) {
      var value =  json[j].categorie;
      if (value) {
        data[i] = json[j];
        i++;
      };
    }


    circle = svg.selectAll("circle")
          .data(data, function(d) { 
            return d.id; 
          });
          
    circle.enter().append("svg:circle")
        .attr("r", function(d) { return 5; } )
        .style("fill", "#d84b2a" )
        .style("stroke-width", 1)
        .attr('id',function(d){ return 'nytg-circle'+d.id })
        .style("stroke", "#d84b2a" )
        .attr("cx", function(d) { return projection([d.longitude, d.latitude])[0]; })
        .attr("cy", function(d) { return projection([d.longitude, d.latitude])[1]; })


    }else {
      //FAIL
    }
}


var nytg = nytg || {};

nytg.ready = function() {

  loadListeEts();

}

var $j = jQuery;

$j(document).ready($j.proxy(nytg.ready, this));


</script>